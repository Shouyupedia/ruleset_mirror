name: sync-upstream

on:
  schedule:
    - cron: "17 */6 * * *" # every 6 hours
  workflow_dispatch:
    inputs:
      force_update:
        description: "Force update ALL files (ignore guard)"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      UPSTREAM: https://github.com/SukkaLab/ruleset.skk.moe.git
      UPSTREAM_BRANCH: master

      THRESHOLD: "0.5"
      MIN_CHANGED_LINES: "10"
      FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream & fetch
        run: |
          set -euo pipefail
          git remote add upstream "${UPSTREAM}" 2>/dev/null || true
          git fetch upstream "${UPSTREAM_BRANCH}" --prune

      - name: Selective sync (per-file guard) + README + Job Summary
        run: |
          set -euo pipefail

          BASE="$(git rev-parse HEAD)"
          NEW="$(git rev-parse upstream/${UPSTREAM_BRANCH})"

          echo "Base: $BASE"
          echo "New : $NEW"
          echo "force_update=${FORCE_UPDATE}"
          echo "threshold=${THRESHOLD}"
          echo "min_changed_lines=${MIN_CHANGED_LINES}"

          # Exclude repo meta only (mirror all rules files)
          EXCLUDE_PATHS=(
            ".github"
            ".gitignore"
            "README.md"
            "README.*"
            "LICENSE"
          )

          is_excluded() {
            local p="$1"
            for ex in "${EXCLUDE_PATHS[@]}"; do
              [[ "$ex" == "README.*" ]] && [[ "$p" == README.* ]] && return 0
              [[ "$p" == "$ex" ]] && return 0
              [[ "$p" == "$ex/"* ]] && return 0
            done
            return 1
          }

          tmp="$(mktemp)"
          git diff --name-status "$BASE" "$NEW" > "$tmp" || true

          skipped_count=0
          updated_count=0
          added_count=0
          keep_deleted_count=0

          # store skipped lines to a file (avoid echo -e portability issues)
          : > skipped.md

          while IFS=$'\t' read -r st a b; do
            [[ -z "${st:-}" ]] && continue

            # rename: Rxxx old new
            if [[ "$st" == R* ]]; then
              old="$a"; new="$b"
              if is_excluded "$new"; then
                continue
              fi
              mkdir -p "$(dirname "$new")"
              git show "$NEW:$new" > "$new"
              git add "$new"
              added_count=$((added_count+1))
              continue
            fi

            path="$a"
            if is_excluded "$path"; then
              continue
            fi

            case "$st" in
              A)
                mkdir -p "$(dirname "$path")"
                git show "$NEW:$path" > "$path"
                git add "$path"
                added_count=$((added_count+1))
                ;;
              M)
                if [[ "$FORCE_UPDATE" == "true" ]]; then
                  mkdir -p "$(dirname "$path")"
                  git show "$NEW:$path" > "$path"
                  git add "$path"
                  updated_count=$((updated_count+1))
                  continue
                fi

                line="$(git diff --numstat "$BASE" "$NEW" -- "$path" | head -n 1 || true)"
                add="$(awk '{print $1}' <<<"$line")"
                del="$(awk '{print $2}' <<<"$line")"
                [[ "$add" == "-" || -z "$add" ]] && add=0
                [[ "$del" == "-" || -z "$del" ]] && del=0

                old_lines="$(git show "$BASE:$path" 2>/dev/null | wc -l || true)"
                new_lines="$(git show "$NEW:$path" 2>/dev/null | wc -l || true)"
                [[ -z "$old_lines" ]] && old_lines=0
                [[ -z "$new_lines" ]] && new_lines=0

                denom=$old_lines
                [[ $new_lines -gt $denom ]] && denom=$new_lines
                [[ $denom -lt 1 ]] && denom=1

                changed=$((add + del))
                ratio="$(awk -v c="$changed" -v d="$denom" 'BEGIN{printf "%.4f", c/d}')"

                if awk -v r="$ratio" -v t="$THRESHOLD" 'BEGIN{exit !(r>t)}' \
                   && [[ "$changed" -ge "$MIN_CHANGED_LINES" ]]; then
                  skipped_count=$((skipped_count+1))
                  printf -- "- \`%s\` (ratio=%s, changed=%s, add=%s, del=%s, base_lines=%s, new_lines=%s)\n" \
                    "$path" "$ratio" "$changed" "$add" "$del" "$old_lines" "$new_lines" >> skipped.md
                  echo "::warning file=$path::Skipped (ratio=$ratio > $THRESHOLD AND changed=$changed >= $MIN_CHANGED_LINES)"
                else
                  mkdir -p "$(dirname "$path")"
                  git show "$NEW:$path" > "$path"
                  git add "$path"
                  updated_count=$((updated_count+1))
                fi
                ;;
              D)
                keep_deleted_count=$((keep_deleted_count+1))
                echo "::notice file=$path::Upstream deleted; keeping local copy (conservative)."
                ;;
              *)
                ;;
            esac
          done < "$tmp"
          rm -f "$tmp"

          now="$(date -u +'%Y-%m-%d %H:%M:%SZ')"
          if [[ ! -s skipped.md ]]; then
            echo "(none)" > skipped.md
          fi

          # Build report.md (no heredoc, no env passing)
          {
            echo "## Auto Update Guard Report"
            echo ""
            echo "- Updated from: \`$BASE\`"
            echo "- Upstream head: \`$NEW\`"
            echo "- Time (UTC): $now"
            echo "- Threshold: ${THRESHOLD}"
            echo "- Min changed lines: ${MIN_CHANGED_LINES}"
            echo "- Force update: ${FORCE_UPDATE}"
            echo "- Updated files: ${updated_count}"
            echo "- Added files: ${added_count}"
            echo "- Upstream deleted but kept: ${keep_deleted_count}"
            echo "- Skipped files (ratio>${THRESHOLD} AND changed>=${MIN_CHANGED_LINES}): ${skipped_count}"
            echo ""
            echo "### Skipped file list"
            cat skipped.md
          } > report.md

          # Enhancement 1: Job Summary (safe with set -u)
          SUMMARY_FILE="${GITHUB_STEP_SUMMARY:-}"
          if [[ -n "$SUMMARY_FILE" ]]; then
            {
              echo "## Mirror Sync Summary"
              echo ""
              echo "- Base: \`$BASE\`"
              echo "- Upstream: \`$NEW\`"
              echo "- Time (UTC): $now"
              echo "- Threshold: ${THRESHOLD}"
              echo "- Min changed lines: ${MIN_CHANGED_LINES}"
              echo "- Force update: ${FORCE_UPDATE}"
              echo ""
              echo "| Item | Count |"
              echo "|---|---:|"
              echo "| Updated files | ${updated_count} |"
              echo "| Added files | ${added_count} |"
              echo "| Upstream deleted but kept | ${keep_deleted_count} |"
              echo "| Skipped files | ${skipped_count} |"
              echo ""
              echo "### Skipped file list"
              echo ""
              cat skipped.md
            } >> "$SUMMARY_FILE"
          else
            echo "::notice::GITHUB_STEP_SUMMARY not set; printing summary to log."
            cat report.md
          fi

          # Update README guard block (from report.md)
          [[ -f README.md ]] || echo "# ruleset mirror" > README.md

          python3 - <<'PY'
          import re, pathlib
          report = pathlib.Path("report.md").read_text(encoding="utf-8", errors="ignore")
          p = pathlib.Path("README.md")
          txt = p.read_text(encoding="utf-8", errors="ignore")
          begin = "<!-- BEGIN_GUARD_REPORT -->"
          end   = "<!-- END_GUARD_REPORT -->"
          block = f"{begin}\n{report}\n{end}"
          if begin in txt and end in txt:
              txt = re.sub(re.escape(begin)+r".*?"+re.escape(end), block, txt, flags=re.S)
          else:
              txt = txt.rstrip() + "\n\n" + block + "\n"
          p.write_text(txt, encoding="utf-8")
          PY

          git add README.md

          # If nothing changed, stop
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "sync: upstream ${NEW:0:7} (skipped ${skipped_count})"

      - name: Push to origin
        run: |
          set -euo pipefail
          git push origin "${{ github.ref_name }}"
